name: Multi-School Birthday Poster Pipeline

on:
  workflow_dispatch:
    branches: [main]
  schedule:
    - cron: "35 00 * * *"

jobs:
  birthday-pipeline:
    name: Generate & Post Birthday Posters for All Schools
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout this repo (where the workflow lives)
      - name: Checkout current repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Clone the python-birthday-reminder repo
      - name: Clone birthday reminder repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/punitdiwan/python-birthday-reminder.git
          cd python-birthday-reminder
          echo "‚úÖ Cloned python-birthday-reminder repository"


      # 3Ô∏è‚É£ Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev libleptonica-dev jq curl

      # 4Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 5Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          cd python-birthday-reminder
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6Ô∏è‚É£ Get project list from Supabase REST API
      - name: Get Project List
        run: |
          echo "Fetching active school projects..."
          curl -s "https://studio.maitretech.com/rest/v1/projects?apikey=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE&is_trial=eq.false&is_disabled=eq.false&order=created_at.desc" \
            | jq -r '.[] | .prj_name' > project.txt
          echo "‚úÖ Created project.txt"
          cat project.txt

      - name: Check for Secrets
        run: |
          if [ -z "${{ secrets.FB_USER_ACCESS_TOKEN }}" ]; then
            echo "‚ùå FB_USER_ACCESS_TOKEN secret is NOT set."
          else
            echo "‚úÖ FB_USER_ACCESS_TOKEN secret is set."
          fi
      # 7Ô∏è‚É£ Run the birthday poster generator for all schools
      - name: Run Birthday Poster Generator
        env:
          ACCESS_TOKEN: ${{ secrets.FB_USER_ACCESS_TOKEN }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          cd python-birthday-reminder

          export DB_HOST="studio.maitretech.com"
          export DB_PORT="5432"
          export DB_NAME="postgres"
          export DB_USER="postgres"

          echo "üéÇ Starting birthday pipeline for all schools..."

          python main.py --run_birthday_pipeline --schools_list ../project.txt

      # 8Ô∏è‚É£ Upload Artifacts (Failures Log + Images)
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: school-processing-results
          path: |
            python-birthday-reminder/birthday-posts/
            python-birthday-reminder/school-failures.json
