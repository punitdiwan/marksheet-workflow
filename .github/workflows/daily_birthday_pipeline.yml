name: üéÇ Multi-School Birthday Poster Pipeline

on:
  schedule:
    # Run every day at 6 AM IST (00:30 UTC) 30 0
    - cron: "30 9 * * *"
  workflow_dispatch: # manual trigger

jobs:
  birthday-pipeline:
    name: Generate and Post Birthday Posters for All Schools
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev libleptonica-dev

      # 3Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4Ô∏è‚É£ Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5Ô∏è‚É£ Fetch active school projects from Supabase REST API
      - name: Get Project List
        run: |
          echo "Fetching active school projects..."
          curl -s "https://studio.maitretech.com/rest/v1/projects?apikey=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE&is_trial=eq.false&is_disabled=eq.false&order=created_at.desc" \
            | jq -r '.[] | .prj_name' > project.txt
          echo "‚úÖ Project list created:"
          cat project.txt

      # 6Ô∏è‚É£ Loop through each school and run birthday pipeline
      - name: Run Birthday Poster Generator for all schools
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "üéì Starting Birthday Poster pipeline for all schools..."
          while IFS= read -r SCHOOL_ID; do
            if [ -z "$SCHOOL_ID" ]; then
              continue
            fi
            echo "--------------------------------------------------"
            echo "üè´ Processing School: $SCHOOL_ID"
            echo "--------------------------------------------------"
            export SCHOOL_ID="$SCHOOL_ID"
            python main.py --run_birthday_pipeline || echo "‚ùå Failed for $SCHOOL_ID"
          done < project.txt

      # 7Ô∏è‚É£ (Optional) Upload logs for debugging
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birthday-pipeline-logs
          path: outputs/
