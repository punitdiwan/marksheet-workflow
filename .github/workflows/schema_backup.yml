name: Backup Script for School

on:
  workflow_dispatch:
    branches:
      - main
    schedule:
    - cron: "30 10 * * *"

jobs:
  backup_schema_school:
    name: Backup Script for School
    runs-on: ubuntu-latest

    steps:
      - name: Dump and upload schemas
        uses: appleboy/ssh-action@v1
        with:
          host: con-in.maitretech.com
          username: root
          key: ${{ secrets.SELF_HOST_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Starting schema exposure job..."
            ############################
            # Variables
            ############################
            DB_HOST="studio.maitretech.com"
            DB_NAME="postgres"
            DB_USER="postgres"
            DB_PORT="5432"
  

            DATE_TIME=$(date '+%Y-%m-%dT-%H:%M:%S')
            ONLY_DATE=$(date '+%Y-%m-%d')
            WORKDIR="$(pwd)"

            ############################
            # Install Node.js
            ############################

            ############################
            # Fetch schemas list
            ############################
            echo "üì• Fetching schema list..."
            curl -s "https://studio.maitretech.com/rest/v1/projects?apikey=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE&is_trial=eq.false&is_disabled=eq.false&order=prj_name.asc" | jq -r ".[] | .prj_name" > $(pwd)/project.txt

            ############################
            # Dump & upload core schemas
            ############################
            for CORE_SCHEMA in auth public; do
              echo "üóÑÔ∏è Dumping schema: ${CORE_SCHEMA}"

              PGPASSWORD=your-super-secret-and-long-postgres-password \
              pg_dump -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USER}" -d "${DB_NAME}" \
                --schema "${CORE_SCHEMA}" \
                -f "${CORE_SCHEMA}_${DATE_TIME}.sql"

              s3cmd put ${CORE_SCHEMA}_${DATE_TIME}.sql s3://schoolerp-bucket/schoolscoop-supa/${CORE_SCHEMA}/${ONLY_DATE}/

              echo "‚òÅÔ∏è Uploaded ${CORE_SCHEMA}"
            done

            ############################
            # Dump & upload dynamic schemas
            ############################
            while read -r schema; do
              schema=$(echo "$schema" | sed 's/\r//g')

              echo "üóÑÔ∏è Dumping schema: ${schema}"

              PGPASSWORD=your-super-secret-and-long-postgres-password \
              pg_dump -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USER}" -d "${DB_NAME}" \
                --schema "${schema}" \
                -f "${schema}_${DATE_TIME}.sql"

              s3cmd put ${schema}_${DATE_TIME}.sql s3://schoolerp-bucket/schoolscoop-supa/${schema}/${ONLY_DATE}/

              echo "‚òÅÔ∏è Uploaded schema: ${schema}"
            done < "${WORKDIR}/project.txt"

            ############################
            # Cleanup
            ############################
            rm -f project.txt *.sql

            echo "üßπ Cleanup completed"
            echo "üéâ All schema dumps and uploads completed successfully!"